<div ng-controller="RepairController">
    <div class="row user-profile animated fadeIn" ng-if="user.id">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4" ng-include="'partials/index-profile.html'"></div>
                <div class="col-md-8" ng-controller="CarController" ng-include="'partials/index-car.html'"></div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="breadcrumb">
            <ul>
                <li>
                    <a ng-click="navigateTo('#/')">{{strings['nav_home']}} ></a>
                </li>
                <li>
                    <a ng-click="navigateTo('#/repairs')">{{strings['nav_repairs']}} ></a>
                </li>
                <li>{{strings['nav_repair']}}</li>
            </ul>
        </div>
        <div class="container">
            <div class="subpage">
                <h1>
                    <img src="img/logo.png" />
                    <span ng-if="!isRepairDetail">{{strings['head_add_repair']}}</span>
                    <span ng-if="isRepairDetail">{{strings['head_edit_repair']}}</span>
                </h1>
                <form name="form" class="repair-form">
                    <span class="sr-only" ng-init="setForm(form)"></span>
                    <div class="section-container">
                        <div class="section">

                            <!--TITLE-->
                            <div class="form-group">
                                <label class="capital">
                                    {{strings['repair_title']}}
                                </label>
                                <input name="title"
                                       type="text"
                                       class="form-control"
                                       placeholder="หัวข้อเรื่องการซ่อมบำรุง"
                                       ng-model="model.title"
                                       ng-required="true" />
                                <p class="error-message margin-top animated fadeIn"
                                   ng-if="form.title.$error.required && form.title.$dirty">
                                    {{strings['required']}}{{strings['repair_title']}}
                                </p>
                            </div>

                            <!--CAR-->
                            <div class="form-group">
                                <label class="capital">
                                    {{strings['select_car']}}
                                </label>
                                <select name="car"
                                        type="text"
                                        class="form-control"
                                        ng-model="model.car"
                                        ng-change="carChange()"
                                        ng-required="true">
                                    <option value=""></option>
                                    <option value="{{car.id}}" ng-repeat="car in cars">{{car.brand}} {{car.series}} {{car.serial}}</option>
                                </select>
                                <p class="error-message margin-top animated fadeIn"
                                   ng-if="form.car.$error.required && form.car.$dirty">
                                    {{strings['required']}}{{strings['select_car']}}
                                </p>
                            </div>

                            <!--WORKGROUP-->
                            <div class="form-group">
                                <label class="capital">
                                    {{strings['repair_workgroup']}}
                                </label>
                                <select name="group"
                                        type="text"
                                        class="form-control"
                                        ng-model="model.work"
                                        ng-required="true">
                                    <option value=""></option>
                                    <option value="{{work.id}}" ng-repeat="work in workgroup">{{work.name}}</option>
                                </select>
                                <p class="error-message margin-top animated fadeIn"
                                   ng-if="form.group.$error.required && form.group.$dirty">
                                    {{strings['required']}}{{strings['repair_workgroup']}}
                                </p>
                            </div>

                            <!--MILE-->
                            <div class="form-group">
                                <label class="capital">
                                    {{strings['repair_mile']}}
                                </label>
                                <input name="mile"
                                       type="number"
                                       class="form-control"
                                       placeholder="เลขกิโลที่ทำการซ่อมบำรุง"
                                       ng-model="model.mile"
                                       ng-required="true" />
                                <p class="error-message margin-top animated fadeIn"
                                   ng-if="form.mile.$error.required && form.mile.$dirty">
                                    {{strings['required']}}{{strings['repair_mile']}}
                                </p>
                                <p class="error-message margin-top animated fadeIn"
                                   ng-if="form.mile.$error.number && form.mile.$dirty">
                                    {{strings['only_number']}}
                                </p>
                            </div>

                            <!--DATE-->
                            <div class="form-group">
                                <label class="capital">
                                    {{strings['repair_date']}}
                                </label>
                                <input type="text"
                                       name="date"
                                       data-value="{{model.date_str}}"
                                       class="form-control datepicker"
                                       placeholder="วันที่ที่ทำการซ่อมบำรุง"
                                       ng-required="true" />
                                <p class="error-message margin-top animated fadeIn"
                                   ng-if="empty_date">
                                    {{strings['required']}}{{strings['repair_date']}}
                                </p>
                            </div>

                            <!--SCORE-->
                            <div class="form-group">
                                <label class="capital">
                                    {{strings['repair_score']}}
                                </label>
                                <select name="score"
                                        type="text"
                                        class="form-control"
                                        ng-model="model.score"
                                        ng-required="true">
                                    <option value=""></option>
                                    <option value="1">แย่มาก</option>
                                    <option value="2">แย่</option>
                                    <option value="3">พอได้</option>
                                    <option value="4">ดี</option>
                                    <option value="5">ดีมาก</option>
                                </select>
                                <p class="error-message margin-top animated fadeIn"
                                   ng-if="form.score.$error.required && form.score.$dirty">
                                    {{strings['required']}}{{strings['repair_score']}}
                                </p>
                            </div>
                            
                        </div>
                        <div class="section">
                            <!--REMARK-->
                            <div class="form-group">
                                <label class="capital">
                                    {{strings['repair_remark']}}
                                </label>
                                <textarea type="text"
                                          class="form-control"
                                          placeholder="กรอกรายละเอียดเพิ่มเติม/หมายเหตุ"
                                          ng-model="model.remark"></textarea>
                            </div>

                            <!--SHOP-->
                            <div class="selected-shop" ng-if="model.shop">
                                <h3>ร้านที่ทำการซ่อมบำรุง</h3>
                                <div class="shop-detail">
                                    <img ng-src="{{model.shop.image.url}}" ng-if="model.shop.image" />
                                    <img src="img/no-photo.jpg" ng-if="!model.shop.image" />
                                    <div class="text">
                                        <span class="shop-name">{{model.shop.name}}</span>
                                        <span class="change-shop"><span class="txt">ดูรายละเอียดร้าน</span></span>
                                        <span class="change-shop"><span class="txt" ng-click="model.shop=undefined;">เปลี่ยนร้าน</span></span>
                                    </div>
                                </div>
                            </div>

                            <!--SHOP-->
                            <div class="form-group" ng-if="!model.shop">
                                <label class="capital">
                                    {{strings['repair_shop']}}
                                </label>

                                <input name="search"
                                       id="searchShop"
                                       type="text"
                                       class="form-control"
                                       ng-model="search.key"
                                       ng-change="searchShop()"
                                       ng-disabled="onSearchShop"
                                       placeholder="ใส่ชื่อร้านเพื่อให้ระบบเริ่มค้นหา" />
                                <p class="error-message margin-top animated fadeIn"
                                   ng-if="!model.shop && form_submit">
                                    {{strings['required']}}{{strings['repair_shop']}}
                                </p>
                                <span class="field-helper">
                                    พิมพ์ชื่อร้านเพื่อค้นหาร้าน เมื่อผลลัพท์แสดงกรุณาหาร้านจากรายการ ถ้าไม่มีผลค้นหาหรือผลลัพท์ให้กดที่ "สร้างใหม่เพราะไม่มีในรายการค้นหา" กรุณาหาจากผลการค้นหาก่อนสร้างร้านใหม่เพื่อป้องกันการสร้างร้านซ้ำซ้อน
                                </span>
                                <div class="sm-load" ng-include="'partials/sm-load.html'" ng-show="onSearchShop"></div>
                                <ul class="shop-list" ng-if="search.key && !onSearchShop && trySearch">
                                    <li ng-repeat="s in shops" ng-click="selectShop(s)">
                                        <img ng-src="{{s.image.url}}" ng-if="s.image" />
                                        <img src="img/no-photo.jpg" ng-if="!s.image" />
                                        <span class="shop-name">{{s.name}}</span>
                                    </li>
                                    <li ng-if="search.key && trySearch" class="add-new" ng-click="createShop()">
                                        <i class="fa fa-plus"></i>
                                        <span>สร้างใหม่เพราะไม่มีในรายการค้นหา</span>
                                    </li>
                                </ul>
                            </div>

                            <!--SHARE-->
                            <div class="form-group">
                                <label class="capital">
                                    {{strings['repair_share']}}
                                </label>
                                <div class="toggle">
                                    <span class="choice yes {{model.share?'active':''}}" ng-click="model.share=true">{{strings['share']}}</span>
                                    <span class="choice no {{model.share?'':'active'}}" ng-click="model.share=false">{{strings['not_share']}}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="works">
                        <h3>รายการที่ทำ <span class="count">({{model.repair_works.length?model.repair_works.length:0}})</span></h3>
                        <p ng-if="!model.id" class="instruction">กรุณาบันทึกงานหลักก่อนถึงจะสามารถเพิ่มรายการซ่อมบำรุงย่อยได้</p>
                        <div class="work-list" ng-repeat="work in model.repair_works">
                            <div class="work-item">
                                <div class="form-group">
                                    <label class="capital">
                                        กลุ่มงาน
                                    </label>
                                    <select name="group"
                                            type="text"
                                            class="form-control"
                                            ng-model="work.work">
                                        <option value=""></option>
                                        <option value="{{work.id}}" ng-repeat="work in workgroup">{{work.name}}</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="capital">
                                        ราคา
                                    </label>
                                    <input name="group"
                                            type="number"
                                            class="form-control"
                                            ng-model="work.price" ng-change="calPrice()" />
                                </div>
                                <div class="form-group">
                                    <label class="capital">
                                        รายละเอียด
                                    </label>
                                    <textarea class="form-control"
                                              ng-model="work.detail"></textarea>

                                </div>
                                <div class="form-group">
                                    <label class="capital">
                                        รูปภาพ
                                    </label>

                                </div>
                                <div class="delete">
                                    <button class="btn btn-danger btn-delete" ng-click="deleteWork($index, work)">
                                        <i class="fa fa-remove"></i><span>ลบ</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="price-sum">ค่าใช้จ่ายรวม: {{model.price?model.price:0}} บาท</p>
                        <p ng-if="status.work_error" class="error-message margin-top animated fadeIn">ไม่สามารถเพิ่มรายการซ่อมบำรุงย่อยได้ กรุณาลองอีกครั้งหรือติดต่อผู้ดูแลระบบ</p>
                        <button class="btn btn-danger" ng-disabled="!model.id" ng-click="addWork()">
                            <i class="fa fa-add"></i>
                            <span>เพิ่มรายการ</span>
                        </button>
                    </div>

                    <p class="error-message margin-top animated fadeIn" ng-if="status.error">{{strings['general_error']}}</p>
                    <p class="error-message margin-top animated fadeIn" ng-if="status.invalid">{{strings['invalid_form']}}</p>
                    <p class="success-message margin-top animated fadeIn" ng-if="status.success">{{strings['update_success']}}</p>
                    <p class="error-message margin-top animated fadeIn" ng-if="status.car_expire">{{strings['car_expire_message']}}</p>
                    <hr />

                    <div class="btn-container" ng-if="!isRepairDetail">
                        <button type="button" class="btn btn-danger" ng-click="add(form)">
                            {{strings['add']}}
                        </button>
                    </div>

                    <div class="btn-container" ng-if="isRepairDetail">
                        <button type="button" class="btn btn-danger" ng-click="update(form)">
                            <i class="fa fa-floppy-o" aria-hidden="true"></i> {{strings['update']}}
                        </button>

                        <button type="button" class="btn btn-danger btn-delete" ng-click="remove()">
                            <i class="fa fa-remove"></i> {{strings['delete']}}
                        </button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>